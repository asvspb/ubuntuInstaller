# План развития Ubuntu Installer: от скриптов к фреймворку (v2)

Этот документ описывает стратегию и тактический план улучшения системы `ubuntuInstaller`, превращения ее из набора процедурных скриптов в гибкий, надежный и конфигурационно-управляемый фреймворк.

## 1. Ключевая идея

Перейти от жестко закодированной логики в скриптах к **декларативному подходу**, где конечный результат описывается в файле конфигурации (`config.yaml`), а фреймворк сам определяет, как достичь этого состояния.

---

## 2. Детальный список недочетов (на основе анализа кода)

Этот раздел конкретизирует общие проблемы, обнаруженные в скриптах.

1.  **Дублирование кода и отсутствие единой библиотеки:**
    *   **Пример:** Блок настройки `sudo` без пароля и отключения `needrestart` полностью скопирован в `1_ubuntuStart.sh` и `2_ubuntuDocker.sh`.
    *   **Последствия:** Усложнение поддержки. Изменение логики требует правок в нескольких местах.

2.  **Жестко закодированная конфигурация:**
    *   **Пример:** Списки пакетов (`apt-get install git gh...`), PPA (`add-apt-repository ppa:thopiekar/openrgb`), URL (`wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb`) и `npm` пакеты (`npm install -g @google/gemini-cli...`) вшиты в скрипты `1_...` и `3_...`.
    *   **Последствия:** Невозможность выбрать компоненты для установки без редактирования кода.

3.  **Отсутствие идемпотентности:**
    *   **Пример:** `add-apt-repository` в `3_ubuntuPack.sh` завершится с ошибкой при повторном запуске. `wget` будет скачивать файлы заново.
    *   **Последствия:** Небезопасные повторные запуски, возможное "загрязнение" системы, ошибки.

4.  **Опасные или нежелательные операции в автоматическом режиме:**
    *   **Пример:** `sudo reboot` в конце `2_ubuntuDocker.sh` — это принудительная перезагрузка без предупреждения.
    *   **Пример:** `read -p "..."` в `6_zerotier-client.sh` останавливает выполнение скрипта до ввода пользователя, что делает невозможным полностью автоматический запуск.

5.  **Потенциальные риски безопасности:**
    *   **Пример:** `echo "${USER} ALL=(ALL) NOPASSWD:ALL" | sudo tee ...` в `1_...` и `2_...` предоставляет беспарольный `sudo` без возможности это контролировать.
    *   **Пример:** `StrictHostKeyChecking no` в `1_...` и `2_...` отключает проверку хоста для `gitlab.com`, что является уязвимостью "man-in-the-middle".
    *   **Пример:** `curl -s https://install.zerotier.com | bash` в `6_...` — классический пример "curl-to-bash", где вы слепо доверяете и исполняете удаленный скрипт без верификации.

6.  **Смешение несвязанных задач (Low Cohesion):**
    *   **Пример:** `1_ubuntuStart.sh` одновременно настраивает `sudo`, системное время, GNOME, устанавливает системные утилиты, Telegram и Chrome. Это 4-5 разных логических "ролей".
    *   **Последствия:** Скрипт превращается в монолит, который трудно тестировать и изменять.

7.  **Неконсистентное качество кода:**
    *   **Пример:** `1_ubuntuStart.sh` — простой линейный скрипт. `4_snap-apps.sh` уже лучше — он читает пакеты из файла. `7_vbox.py` — это полноценное, сложное приложение на Python с парсингом HTML, определением версий и обработкой ошибок.
    *   **Последствия:** Проект трудно поддерживать из-за отсутствия единого стандарта качества.

8.  **Отсутствие очистки:**
    *   **Пример:** `wget ...` скачивает `.deb` пакеты, но `rm` вызывается не всегда, что может оставить мусор в системе. `7_vbox.py` делает это правильно.

---

## 3. Детальный тактический план рефакторинга

Этот план детализирует миграцию каждого скрипта в новую модульную структуру.

### Фаза 1: Создание фундамента

1.  **Задача 1.1: Создать новую структуру проекта.**
    *   **Действие:** Создать директории `roles`, `config`, `lib`. Создать пустые файлы `install.sh`, `config/default.yaml`, `lib/common.sh`.

2.  **Задача 1.2: Реализовать `config/default.yaml`.**
    *   **Действие:** Наполнить `default.yaml` структурой, включающей списки для `apt_packages`, `snap_packages`, `npm_packages`, `ppa_repositories`, а также булевы флаги для включения ролей и их параметры.

3.  **Задача 1.3: Реализовать движок `install.sh` и библиотеку `lib/common.sh`.**
    *   **Действие (`lib/common.sh`):** Написать общие функции: `log_info`, `log_error`, `is_pkg_installed`, `add_ppa_idempotent`, `verify_and_download`.
    *   **Действие (`install.sh`):** Написать логику, которая парсит YAML (с помощью `yq`), итерирует по включенным ролям и запускает `roles/{role_name}/main.sh`.

### Фаза 2: Миграция скриптов в роли

1.  **Задача 2.1: Рефакторинг `1_ubuntuStart.sh` и `3_ubuntuPack.sh`**
    *   **Роль `base-system`:**
        *   Перенести логику `sudoers` и `needrestart` в `main.sh`, сделав ее отключаемой через `config.yaml`.
        *   Перенести настройку `timedatectl`.
        *   Перенести базовые пакеты (`git`, `mc`, `curl`...) в `config.yaml` в секцию `roles.base-system.apt_packages`.
    *   **Роль `gnome-desktop`:**
        *   Перенести `gsettings` и установку `gnome-tweaks`, `dconf-editor`.
    *   **Роль `dev-tools`:**
        *   Перенести установку `python3`, `pip`, `npm`, `nodejs`.
        *   Перенести `npm install -g ...` в `config.yaml` в секцию `roles.dev-tools.npm_packages`.
    *   **Роль `ppa-manager`:**
        *   Перенести все `add-apt-repository` из `3_...` в `config.yaml` в секцию `roles.ppa-manager.repositories`. Роль будет использовать `add_ppa_idempotent` из `lib/common.sh`.
    *   **Роли для приложений (`google-chrome`, `warp-terminal`, `speedtest-cli`):**
        *   Создать отдельные роли для каждого. Логика скачивания и установки переносится в `main.sh` роли, но использует `verify_and_download` из `lib/common.sh`.

2.  **Задача 2.2: Рефакторинг `2_ubuntuDocker.sh`**
    *   **Роль `docker`:**
        *   Перенести всю логику установки Docker CE, `docker-compose` и `lazydocker`.
        *   **Заменить `sudo reboot`** на `log_info "Для завершения настройки Docker требуется перезагрузка или перелогин."`.
        *   Удаление старых версий сделать идемпотентным.

3.  **Задача 2.3: Рефакторинг `4_snap-apps.sh`**
    *   **Роль `snap-apps`:**
        *   Перенести логику `snap install`.
        *   Список пакетов из `ubuntu_snap_packages.txt` перенести в `config.yaml` в секцию `roles.snap-apps.packages`.
        *   Логику `if lspci | grep -q "NVIDIA"` сделать условным включением пакета `mesa-2404` на основе переменной в `config.yaml`.

4.  **Задача 2.4: Рефакторинг `5_samsung-printer-driver.sh`**
    *   **Роль `samsung-printer`:**
        *   Скрипт уже достаточно качественный. Его можно просто обернуть в роль: `main.sh` будет вызывать `./5_samsung-printer-driver.sh --auto-install-cups-client --auto-set-default-printer`. Параметры можно вынести в `config.yaml`.

5.  **Задача 2.5: Рефакторинг `6_zerotier-client.sh`**
    *   **Роль `zerotier`:**
        *   Перенести логику в `main.sh`.
        *   **Заменить `curl | bash`** на безопасную установку с верификацией.
        *   **Убрать интерактивный ввод `read -p`**. ID сети должен передаваться через `config.yaml` (`roles.zerotier.network_id`).

6.  **Задача 2.6: Рефакторинг `7_vbox.py`**
    *   **Роль `virtualbox`:**
        *   Аналогично принтеру, скрипт можно обернуть. `main.sh` будет вызывать `python3 7_vbox.py`.
        *   **Убрать интерактивный ввод `input(...)`**. Решение (установить/удалить) должно приниматься на основе наличия роли в `config.yaml`.

### Фаза 3: Расширение функционала и безопасность (Medium Priority)

*   **Реализовать `uninstall`/`update`**: Добавить протокол в `install.sh` для вызова `uninstall.sh`/`update.sh` в папках ролей.
*   **Мини-TUI (`whiptail`/`gum`):** Создать интерактивный режим для выбора ролей и редактирования переменных.
*   **Роль «secure-by-default»:** `ufw enable`, `unattended-upgrades`, безопасная конфигурация `sudo`.

### Фаза 4: Профили и документация

*   **Профили:** Определить наборы ролей и переменных для `desktop-developer`, `wsl`, `server`.
*   **Документация:** Обновить `README.md` и добавить инструкции по созданию новых ролей.