# План развития Ubuntu Installer: от скриптов к фреймворку

Этот документ описывает стратегию улучшения системы `ubuntuInstaller`, превращения ее из набора процедурных скриптов в гибкий, надежный и конфигурационно-управляемый фреймворк.

## 1. Ключевая идея

Перейти от жестко закодированной логики в скриптах к **декларативному подходу**, где конечный результат описывается в файле конфигурации (`config.yaml`), а фреймворк сам определяет, как достичь этого состояния.

---

## 2. Анализ недостатков и предлагаемые решения

Текущие недостатки сгруппированы по категориям для лучшего понимания.

### Категория A: Архитектура и гибкость

*   **Проблемы:**
    *   `1. Управление конфигурацией`: Нет центрального конфига.
    *   `7. Модульность`: Монолитные скрипты.
    *   `8. Профили пользователей`: Нет разделения по ролям (developer, server).
    *   `9. Зависимости`: Неявные зависимости между скриптами.
*   **Вектор решения:** Внедрение **конфигурационного файла** (YAML) и **модульной структуры ("роли")**.

    *   **`config.yaml`**: Определяет, *что* устанавливать (компоненты, пакеты, профили).
    *   **Роли (`roles/`)**: Директории с задачами, шаблонами и файлами для каждого компонента (e.g., `roles/docker/`, `roles/dev-tools/`).
    *   **Библиотека (`lib.sh`)**: Общие функции для всех модулей.

### Категория B: Надежность и исполнение

*   **Проблемы:**
    *   `2. Идемпотентность`: Повторные запуски могут вызывать ошибки.
    *   `4. Проверка системы`: Нет "preflight" проверок (версия ОС, сеть).
    *   `6. Обработка ошибок`: Падение одного шага оставляет систему в "грязном" состоянии.
    *   `5. Логирование`: Отсутствие централизованного лога.
*   **Вектор решения:** Реализация **надежного исполнителя (engine)**.

    *   **Идемпотентность**: Каждая задача должна проверять текущее состояние перед выполнением (e.g., `is_package_installed "git"`).
    *   **Pre-flight Checks**: Обязательный шаг перед запуском основных задач.
    *   **Error Handling**: Использование `trap` и `set -Eeuo pipefail`.
    *   **Logging**: Все выводы направляются в `/var/log/ubuntuInstaller/install-YYYY-MM-DD.log` с уровнями (INFO, WARN, ERROR).

### Категория C: Безопасность и верификация

*   **Проблемы:**
    *   `11. Базовая безопасность`: Нет профиля "secure-by-default".
    *   `16. Pinning и верификация`: Внешние скрипты и бинарники скачиваются без проверки.
*   **Вектор решения:** Внедрение **политик безопасности по умолчанию**.

    *   **Верификация**: Проверка SHA256/GPG для всех внешних артефактов.
    *   **Безопасность**: UFW, `unattended-upgrades` и другие практики должны быть включены в базовый профиль.

### Категория D: Управление состоянием

*   **Проблемы:**
    *   `3. Обратимость`: Нет механизма отката или удаления компонентов.
    *   `10. Обновления`: Нет пути для обновления уже установленных компонентов.
*   **Вектор решения:** Создание **простого механизма управления состоянием**.

    *   **State-файл**: Простой текстовый файл (`/var/lib/ubuntuInstaller.state`), перечисляющий установленные роли.
    *   **Команды `install | uninstall | update`**: Логика для установки, удаления и обновления компонентов на основе state-файла.

---

## 3. Приоритетный план действий

### Фаза 1: Создание фундамента (High Priority)

Цель: реализовать базовую архитектуру "конфиг + модули".

**1. Создать структуру проекта:**
```
/ubuntuInstaller
├── install.sh              # Главный скрипт-исполнитель
├── config.yaml             # Конфигурационный файл
├── lib.sh                  # Общая библиотека функций
└── roles/
    ├── 00-base-system/     # Базовая настройка системы (apt, users)
    │   └── main.sh
    ├── 10-dev-tools/       # Инструменты разработчика
    │   └── main.sh
    └── 20-docker/          # Установка Docker
        └── main.sh
```

**2. Создать `config.yaml`:**
```yaml
# config.yaml
settings:
  username: "asv-spb" # Автоматически определять, если не задано
  non_interactive: true
  log_file: "/var/log/ubuntuInstaller/install.log"

# Профиль определяет набор ролей
profile: "developer"

# Список доступных ролей для установки
roles_enabled:
  - name: "base-system"
  - name: "dev-tools"
    vars: # Переменные для роли
      install_vscode: true
      install_pycharm: false
  - name: "docker"
    enabled: true # Можно включать/выключать роли напрямую
```

**3. Реализовать `install.sh` (engine):**
*   Парсит `config.yaml` (можно использовать простой парсер на Python/Ruby или `yq`).
*   Выполняет pre-flight checks.
*   Последовательно запускает `main.sh` из каждой включенной роли в директории `roles/`.
*   Ведет централизованный лог.

**4. Рефакторинг `1_ubuntuStart.sh`:**
*   Перенести его логику в роль `roles/00-base-system/`.
*   Списки пакетов вынести в переменные в `config.yaml`.

**5. Настроить CI:**
*   Добавить GitHub Action для запуска `shellcheck` и `shfmt` на все `.sh` файлы.

**Критерий успеха Фазы 1:** Установка базовой системы и инструментов разработчика запускается одной командой `sudo ./install.sh`, управляется через `config.yaml` и идемпотентна.

### Фаза 2: Расширение функционала (Medium Priority)

*   **Реализовать `uninstall`**: Добавить логику в `install.sh` для вызова `uninstall.sh` в папках ролей.
*   **Мини-TUI**: Создать интерактивный режим (`whiptail`/`gum`), который позволяет выбрать роли и редактировать переменные перед запуском.
*   **Верификация загрузок**: Добавить в `lib.sh` функцию для проверки хеш-сумм.
*   **Создать больше ролей**: Перенести логику из остальных скриптов (`2_...`, `3_...`) в соответствующие роли.

---

## 4. Рекомендации по открытым вопросам

1.  **Релизы и архитектуры:**
    *   **Рекомендация:** Официально поддерживать **Ubuntu 22.04 LTS и 24.04 LTS** для архитектуры **amd64**. Поддержку `arm64` можно добавить позже как второстепенную цель.

2.  **Критичность "secure-by-default":**
    *   **Рекомендация:** **Да, критичен.** Система должна быть безопасной по умолчанию. Отключение `sudo NOPASSWD` — правильный шаг. Опции, ослабляющие безопасность, должны быть явно включены в `config.yaml` пользователем, который понимает риски.

3.  **Профили WSL/сервер:**
    *   **Рекомендация:** Начать с профиля `desktop-developer`. После того как архитектура стабилизируется, добавить профили `wsl` и `server` будет очень просто (это будут просто другие наборы ролей в `config.yaml`).

4.  **Переход на Ansible/Nix:**
    *   **Рекомендация:** Предложенный план (роли, YAML, переменные) является **идеальным промежуточным шагом к Ansible**. Структура `roles/` почти полностью повторяет структуру ролей Ansible. Когда вы решите перейти, миграция будет заключаться в замене `main.sh` на `tasks/main.yml`. **Ваша работа не пропадет даром.**

Этот план превратит ваш проект в мощный инструмент, который будет легко поддерживать и развивать.
