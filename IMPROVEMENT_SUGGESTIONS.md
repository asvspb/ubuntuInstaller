# План развития Ubuntu Installer: от скриптов к фреймворку

Этот документ описывает стратегию улучшения системы `ubuntuInstaller`, превращения ее из набора процедурных скриптов в гибкий, надежный и конфигурационно-управляемый фреймворк.

## 1. Ключевая идея

Перейти от жестко закодированной логики в скриптах к **декларативному подходу**, где конечный результат описывается в файле конфигурации (`config.yaml`), а фреймворк сам определяет, как достичь этого состояния.

---

## 2. Анализ недостатков и предлагаемые решения

Текущие недостатки сгруппированы по категориям для лучшего понимания.

### Категория A: Архитектура и гибкость

*   **Проблемы:**
    *   `1. Управление конфигурацией`: Нет центрального конфига.
    *   `7. Модульность`: Монолитные скрипты.
    *   `8. Профили пользователей`: Нет разделения по ролям (developer, server).
    *   `9. Зависимости`: Неявные зависимости между скриптами.
*   **Вектор решения:** Внедрение **конфигурационного файла** (YAML) и **модульной структуры ("роли")**.

    *   **`config.yaml`**: Определяет, *что* устанавливать (компоненты, пакеты, профили).
    *   **Роли (`roles/`)**: Директории с задачами, шаблонами и файлами для каждого компонента (e.g., `roles/docker/`, `roles/dev-tools/`).
    *   **Библиотека (`lib.sh`)**: Общие функции для всех модулей.

### Категория B: Надежность и исполнение

*   **Проблемы:**
    *   `2. Идемпотентность`: Повторные запуски могут вызывать ошибки.
    *   `4. Проверка системы`: Нет "preflight" проверок (версия ОС, сеть).
    *   `6. Обработка ошибок`: Падение одного шага оставляет систему в "грязном" состоянии.
    *   `5. Логирование`: Отсутствие централизованного лога.
*   **Вектор решения:** Реализация **надежного исполнителя (engine)**.

    *   **Идемпотентность**: Каждая задача должна проверять текущее состояние перед выполнением (e.g., `is_package_installed "git"`).
    *   **Pre-flight Checks**: Обязательный шаг перед запуском основных задач.
    *   **Error Handling**: Использование `trap` и `set -Eeuo pipefail`.
    *   **Logging**: Все выводы направляются в `/var/log/ubuntuInstaller/install-YYYY-MM-DD.log` с уровнями (INFO, WARN, ERROR).

### Категория C: Безопасность и верификация

*   **Проблемы:**
    *   `11. Базовая безопасность`: Нет профиля "secure-by-default".
    *   `16. Pinning и верификация`: Внешние скрипты и бинарники скачиваются без проверки.
*   **Вектор решения:** Внедрение **политик безопасности по умолчанию**.

    *   **Верификация**: Проверка SHA256/GPG для всех внешних артефактов.
    *   **Безопасность**: UFW, `unattended-upgrades` и другие практики должны быть включены в базовый профиль.

### Категория D: Управление состоянием

*   **Проблемы:**
    *   `3. Обратимость`: Нет механизма отката или удаления компонентов.
    *   `10. Обновления`: Нет пути для обновления уже установленных компонентов.
*   **Вектор решения:** Создание **простого механизма управления состоянием**.

    *   **State-файл**: Простой текстовый файл (`/var/lib/ubuntuInstaller.state`), перечисляющий установленные роли.
    *   **Команды `install | uninstall | update`**: Логика для установки, удаления и обновления компонентов на основе state-файла.


### 2.1. Обнаруженные недочёты в текущем репозитории (по состоянию на изучение)

- CI (GitHub Actions):
  - shellcheck/shfmt используются, но не устанавливаются в шаге Install dependencies (workflow упадёт).
  - Нет прогона вспомогательных проверок из test-docs.sh (валидаторы YAML, dry-run примеров, проверки разделов в README).
- Makefile:
  - Опечатка в коде сброса цвета: `NC := \03[0m` → должно быть `\033[0m`.
- YAML и генерация конфигов:
  - profiles/server.yaml и test-config.yaml — некорректные отступы (риски падения yq).
  - mini-tui.sh — неверный отступ у `log_file` при генерации YAML.
- Права выполнения:
  - install.sh не требует root в начале (роли вызывают apt/systemctl). Нужен `require_root`.
- Docker (конфликт ролей):
  - roles/10-dev-tools устанавливает `docker.io`, а roles/20-docker — официальный Docker CE. Конфликт/дублирование.
  - roles/20-docker проверяет/удаляет «старый docker» через `is_pkg_installed "docker"` (пакета с именем `docker` нет). Нужна проверка `command -v docker` и удаление набора известных пакетов.
- Preflight-сеть:
  - Проверка только ping 8.8.8.8; в ряде окружений ICMP запрещён. Нужен HTTP‑fallback (curl/wget --spider).
- DRY‑RUN и зависимость yq:
  - В dry-run yq не устанавливается; при его отсутствии количество ролей может определяться как 0. Нужен явный pre-req (документация) либо безопасная установка yq и в dry‑run.
- Secure-by-default vs удобство:
  - roles/0-base-system включает NOPASSWD для sudo и пишет SSH config с `StrictHostKeyChecking no` для gitlab.com — это противоречит роли 30-secure-default. Сделать опционально и по умолчанию выключить.
- Аутентификация/блокировки:
  - 30-secure-default использует pam_tally2; на 22.04+/24.04 предпочтительнее pam_faillock.
- VirtualBox:
  - `virtualbox-ext-pack` требует принятия лицензии и может падать в non-interactive. Нужны debconf‑preseed/флаги или альтернативная установка.
- Uninstall/update:
  - Движок поддерживает uninstall/update, но в ролях отсутствуют `uninstall.sh` — функциональность частично реализована.
- Верификация загрузок:
  - В ролях пока не используется `download_with_verification`; ZeroTier устанавливается через `curl | bash` без проверки.
- Документация:
  - В README есть дубли разделов «Role Development»/«Legacy Scripts» внизу; стоит убрать повторы и выровнять структуру.
- UX TUI:
  - mini-tui: проверить установку/зависимости whiptail, улучшить подсказки; учесть WSL/Server (скрывать неподходящие роли).

---

---

## 3. Приоритетный план действий

### Фаза 0: Основание и защитные барьеры (High Priority)
Цель: договориться о стандартах, ввести базовые проверки качества и общую библиотеку, чтобы ускорить последующие фазы.
- Deliverables:
  - Матрица поддержки (22.04/24.04; amd64) задокументирована в README.
  - Makefile: `make lint`, `make fmt`, `make dry-run`, `make install`.
  - CI (GitHub Actions): `shellcheck` + `shfmt` на все `.sh`.
  - `lib.sh`: логирование (INFO/WARN/ERROR, вывод в файл + консоль), `run_with_retry`, `require_root`, `preflight_checks` (дистрибутив/версия, сеть, свободное место), `is_pkg_installed`, `ensure_pkg`, `hash_verify`, `gpg_verify`.
  - Флаг `--dry-run`/`UBUNTU_INSTALLER_DRY_RUN=1` (никаких изменений, только план + проверки).
- Критерии приёмки:
  - CI зелёный; `make lint` локально — без ошибок.
  - `./install.sh --dry-run` работает и печатает план выполнения без изменений в системе.


#### Фаза 0 — дополнения (быстрые правки в репозитории)
- CI/workflow: установить shellcheck и shfmt в шаге Install dependencies; добавить шаг с `./test-docs.sh` (safe‑checks).
- Makefile: исправить `NC` на `\033[0m`.
- Требование root: добавить `require_root` сразу после подключения `lib.sh` в install.sh.
- YAML‑качество: поправить отступы в profiles/server.yaml, test-config.yaml; исправить отступ у `log_file` в mini-tui.sh; добавить рекомендацию по установке yq (README) и/или безопасную установку yq в dry‑run.
- Docker: убрать `docker.io` из 10-dev-tools; в 20-docker переехать на проверку `command -v docker` и корректное удаление старых пакетов; не мешать CE.
- Preflight: добавить HTTP‑проверку (curl/wget) как fallback на случай запрета ICMP.
- Secure defaults по умолчанию: сделать NOPASSWD и SSH‑ослабления опциональными (выключены по умолчанию, включаются через vars профиля).
- VirtualBox: предусмотреть non‑interactive согласие лицензии ext‑pack (debconf‑preseed) или задокументированный интерактивный шаг.
- Верификация загрузок: внедрить `download_with_verification` минимум для внешних .deb/скриптов (ZeroTier, VSCode ключ/репо и т.п.).
- Документация: убрать дубли в README, кратко сослаться на HOWTO.add-role.md.
- Критерии приёмки (дополнение): workflow зелёный; `./install.sh --dry-run` работает даже если yq отсутствовал до запуска (либо понятно задокументировано как prerequisite).


### Фаза 1: Архитектура «config + роли» (High Priority)
Цель: реализовать основу фреймворка и перенести базовую настройку.
- Структура проекта:
```
/ubuntuInstaller
├── install.sh              # Главный скрипт-исполнитель
├── config.yaml             # Конфигурация (профиль/роли/переменные)
├── lib.sh                  # Общая библиотека функций
└── roles/
    ├── 00-base-system/
    │   └── main.sh
    ├── 10-dev-tools/
    │   └── main.sh
    └── 20-docker/
        └── main.sh
```
- `config.yaml` (пример):
```yaml
settings:
  non_interactive: true
  log_file: "/var/log/ubuntuInstaller/install.log"
profile: "developer"
roles_enabled:
  - name: base-system
  - name: dev-tools
    vars:
      install_vscode: true
      install_pycharm: false
  - name: docker
    enabled: true
```
- `install.sh` (engine):
  - Парсинг `config.yaml` (yq/pyyaml), preflight, последовательный запуск ролей, централизованный лог.
  - Встроенная идемпотентность ролей: перед действием проверять состояние (pkg/snap/file/service).
- Рефакторинг `1_ubuntuStart.sh` → `roles/00-base-system` (списки пакетов и gsettings выносятся в переменные `config.yaml`).
- Критерии приёмки:
  - Два подряд запуска `sudo ./install.sh -c config.yaml` дают одинаковый результат (нет повторных действий).
  - Базовая система и dev-инструменты устанавливаются из ролей под управлением конфига.


#### Фаза 1 — уточнения
- Роли и конфликты:
  - Исключить пересечения: dev-tools не должен ставить Docker; Docker управляется только ролью 20-docker.
  - Разнести спорные системные правки: NOPASSWD/SSH‑ослабления — в отдельную (выключенную по умолчанию) ветку роли или через vars профиля.
- Идемпотентность по умолчанию:
  - Во всех ролях перед действием проверять состояние (pkg/snap/file/service) и изменять только при необходимости.
- Acceptance (дополнение): два подряд запуска и «переключение» vars не приводят к лишним действиям; никакие конфликты пакетов не возникают.


### Фаза 2: Расширение функционала и безопасность (Medium Priority)
- `uninstall`/`update`: протокол в `install.sh` (поиск `uninstall.sh`/`update.sh` в ролях, ведение state-файла `/var/lib/ubuntuInstaller.state`).
- Мини‑TUI (`whiptail`/`gum`): выбор профиля/ролей, просмотр плана, переключение переменных перед запуском.
- Верификация загрузок: `hash_verify`/`gpg_verify` применены для внешних .deb/скриптов (Chrome, Warp, VirtualBox и т. п.).
- Роль «secure-by-default»: `ufw enable`, `unattended-upgrades`, безопасная конфигурация sudo через `/etc/sudoers.d` с `visudo -c`.
- Миграция скриптов `2_...`, `3_...`, `4_...` в роли (docker, snap-apps, dev-pack и пр.).
- Критерии приёмки:
  - `./install.sh uninstall --role docker` корректно удаляет Docker без «хвостов».
  - Мини‑TUI формирует корректный `config.yaml` и запускает установку.


#### Фаза 2 — уточнения
- Uninstall:
  - Добавить минимальные `uninstall.sh` для ключевых ролей (20-docker, 80-virtualbox, 40-snap-apps, 50-dev-pack) — даже если это «мягкое» удаление.
- Верификация:
  - Применить `download_with_verification` в ролях для внешних артефактов (ZeroTier, VSCode key/repo), проверка хэшей/подписей.
- Mini‑TUI:
  - Корректная генерация YAML (отступы), подсказки по профилям, скрытие неподходящих ролей для WSL/Server.
- Acceptance (дополнение): `./install.sh uninstall --role docker` удаляет без хвостов; TUI генерирует валидный YAML (проверено yq).


### Фаза 3: Профили и аппаратная осведомлённость (Medium Priority)
- Профили: `desktop-developer`, `wsl`, `server` (разные наборы ролей и переменных).
- Автоопределение окружения: NVIDIA/AMD/Intel (ветки в ролях), ноутбуки (TLP/PPD), VM/WSL (пропуск Snap, особые шаги).
- Критерии приёмки:
  - На системе с NVIDIA выбирается ветка с корректными драйверами.
  - На WSL роли, несовместимые со Snap/GUI, автоматически пропускаются.

### Фаза 4: Откаты и управление состоянием (Medium Priority)
- State‑файл: что установлено, версии, параметры.
- `rollback` (опционально): pre‑snapshot (Timeshift/ZFS — если доступно) для критичных ролей; мягкие откаты через uninstall.
- Критерии приёмки:
  - `./install.sh update` обновляет включённые роли без разрушения кастомных настроек.
  - `./install.sh uninstall --role virtualbox` возвращает систему в чистое состояние.

### Фаза 5: Документация и тесты (Low Priority)
- Документация: README (быстрый старт, матрица совместимости), HOWTO по добавлению ролей, примеры `config.yaml`.
- Авто‑смоук тест в CI: контейнер/VM с `--dry-run` + синтаксические проверки ролей.
- Критерии приёмки:
  - В README есть примеры для `developer`, `wsl`, `server`.
  - CI прогоняет `--dry-run` и линтеры на PR.


#### Фаза 5 — уточнения
- Интегрировать `./test-docs.sh` в CI как быстрый smoke (yaml‑lint, dry‑run примеров, проверка разделов в README).
- Упростить/сжать README (убрать дубли), ссылаться на HOWTO и README.quickstart.


---

## 4. Рекомендации по открытым вопросам

1.  **Релизы и архитектуры:**
    *   **Рекомендация:** Официально поддерживать **Ubuntu 22.04 LTS и 24.04 LTS** для архитектуры **amd64**. Поддержку `arm64` можно добавить позже как второстепенную цель.

2.  **Критичность "secure-by-default":**
    *   **Рекомендация:** **Да, критичен.** Система должна быть безопасной по умолчанию. Отключение `sudo NOPASSWD` — правильный шаг. Опции, ослабляющие безопасность, должны быть явно включены в `config.yaml` пользователем, который понимает риски.

3.  **Профили WSL/сервер:**
    *   **Рекомендация:** Начать с профиля `desktop-developer`. После того как архитектура стабилизируется, добавить профили `wsl` и `server` будет очень просто (это будут просто другие наборы ролей в `config.yaml`).

4.  **Переход на Ansible/Nix:**
    *   **Рекомендация:** Предложенный план (роли, YAML, переменные) является **идеальным промежуточным шагом к Ansible**. Структура `roles/` почти полностью повторяет структуру ролей Ansible. Когда вы решите перейти, миграция будет заключаться в замене `main.sh` на `tasks/main.yml`. **Ваша работа не пропадет даром.**

Этот план превратит ваш проект в мощный инструмент, который будет легко поддерживать и развивать.
