#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á–µ—Ä–µ–∑ sudo
sudo -l


# –ò–º—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–µ root, –∞ —Ç–æ–≥–æ, –∫—Ç–æ –∑–∞–ø—É—Å—Ç–∏–ª —Å–∫—Ä–∏–ø—Ç —á–µ—Ä–µ–∑ sudo)
REAL_USER=${SUDO_USER:-$USER}

# –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–π –º—ã –±—É–¥–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å/—É–¥–∞–ª—è—Ç—å
CONFIG_FILE="/etc/sudoers.d/${REAL_USER}-nopasswd"

# –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–∫—Ä–∏–ø—Ç –æ—Ç root
if [ "$EUID" -ne 0 ]; then
  echo "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Å sudo:"
  echo "   sudo ./sudo_toggle.sh [on|off]"
  exit 1
fi

case "$1" in
  off)
    echo "üîì –û—Ç–∫–ª—é—á–∞–µ–º –∑–∞–ø—Ä–æ—Å –ø–∞—Ä–æ–ª—è sudo –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $REAL_USER..."
    # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –ø—Ä–∞–≤–∏–ª–æ–º NOPASSWD
    echo "$REAL_USER ALL=(ALL) NOPASSWD:ALL" > "$CONFIG_FILE"
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ 0440, –∏–Ω–∞—á–µ sudo –±—É–¥–µ—Ç —Ä—É–≥–∞—Ç—å—Å—è)
    chmod 0440 "$CONFIG_FILE"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
    if visudo -c -f "$CONFIG_FILE" > /dev/null; then
        echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å sudo –Ω–µ –±—É–¥–µ—Ç –ø—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å."
    else
        echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞! –û—Ç–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
        rm "$CONFIG_FILE"
        exit 1
    fi
    ;;

  on)
    echo "üîí –í–∫–ª—é—á–∞–µ–º –∑–∞–ø—Ä–æ—Å –ø–∞—Ä–æ–ª—è sudo –æ–±—Ä–∞—Ç–Ω–æ..."
    if [ -f "$CONFIG_FILE" ]; then
      rm "$CONFIG_FILE"
      echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –ü–∞—Ä–æ–ª—å —Å–Ω–æ–≤–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è."
    else
      echo "‚ÑπÔ∏è –ü–∞—Ä–æ–ª—å –∏ —Ç–∞–∫ –≤–∫–ª—é—á–µ–Ω (—Ñ–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω)."
    fi
    ;;

  *)
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
    echo "  sudo ./sudo_toggle.sh off  -> –û—Ç–∫–ª—é—á–∏—Ç—å –ø–∞—Ä–æ–ª—å (—É–¥–æ–±–Ω–æ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏)"
    echo "  sudo ./sudo_toggle.sh on   -> –í–∫–ª—é—á–∏—Ç—å –ø–∞—Ä–æ–ª—å –æ–±—Ä–∞—Ç–Ω–æ (–±–µ–∑–æ–ø–∞—Å–Ω–æ)"
    exit 1
    ;;
esac

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á–µ—Ä–µ–∑ sudo
sudo -l