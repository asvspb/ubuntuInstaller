# Ubuntu Installer Framework

Этот репозиторий содержит фреймворк для автоматизации установки новой системы Ubuntu с использованием декларативного подхода.

## Компоненты фреймворка

*   `./install.sh` - Официальный главный скрипт установки, который координирует процесс установки.
*   `config.yaml` - Конфигурационный файл, определяющий, какие компоненты устанавливать (профили, роли, переменные).
*   `lib.sh` - Общая библиотека функций для всех модулей (логирование, обработка ошибок, управление пакетами и т.д.).
*   `Makefile` - Содержит цели для линтинга, форматирования, симуляции и установки.
*   `roles/` - Директория с модульными ролями для различных компонентов (base-system, dev-tools, docker и т.д.).

## Скрипты (Устаревшие)

Вся директория `scripts/` содержит устаревшие скрипты, которые больше не поддерживаются.
Пожалуйста, используйте основной скрипт `./install.sh` в корне проекта для установки.

*   `scripts/1_ubuntuStart.sh` - Устаревший скрипт - Устанавливает системное время, минимальный набор сетевых инструментов, Chrome и Telegram. Также отключает запрос пароля sudo.
*   `scripts/2_ubuntuDocker.sh` - Устаревший скрипт - Устанавливает Docker и среду разработки. Требует перезагрузку после выполнения.
*   `scripts/3_ubuntuPack.sh` - Устаревший скрипт - Устанавливает расширенный набор приложений для разработчиков.
*   `scripts/4_snap-apps.sh` - Устаревший скрипт - Устанавливает рекомендуемые Snap приложения.
*   `scripts/5_samsung-printer-driver.sh` - Устаревший скрипт - Устанавливает драйвер для принтеров Samsung.
*   `scripts/6_zerotier-client.sh` - Устаревший скрипт - Устанавливает ZeroTier клиент для Ubuntu.
*   `scripts/7_vbox.py` - Устаревший скрипт - Устанавливает VirtualBox и настраивает среду для виртуальных машин.
*   `scripts/ubuntu_snap_packages.txt` - Содержит список рекомендуемых snap пакетов.

## Дополнительные файлы

*   `$USER/` - Содержит минимальные настройки Ubuntu, конфигурации bash/zsh, gitconfig и скрипты очистки.
*   `$USER/Dev/AI.code-profile` - Профиль Visual Studio Code.
*   `music/` - Содержит ссылки на радиопотоки.
*   `$USER/OpenRGB/` - Содержит скрипты и конфигурации для OpenRGB.
*   `$USER/Templates/` - Содержит шаблоны HTML, JavaScript, Python и README.
*   `$USER/themes/` - Содержит темы для Ubuntu (BigSur, Graphite, Monterey, Ventoy-Dark, xu).
*   `PROGRAM_DESCRIPTIONS.md` - Содержит подробные описания программ, устанавливаемых скриптами.
*   `IMPROVEMENT_SUGGESTIONS.md` - Дорожная карта развития для перехода от скриптов к фреймворку.

## Поддерживаемые версии

*   Ubuntu 22.04 LTS
*   Ubuntu 24.04 LTS
*   Архитектура: amd64

## Архитектура

Ubuntu Installer Framework следует модульному, декларативному подходу:

### Конфигурационно-управляемая установка

* Использует конфигурационные файлы в формате YAML для определения желаемого состояния системы
* Поддерживает различные профили (developer, server, wsl) с настраиваемыми ролями
* Переменные могут передаваться в роли для настройки поведения

### Модульная система ролей

* Каждый компонент инкапсулирован в роль (например, base-system, dev-tools, docker)
* Роли хранятся в директории `roles/` с числовыми префиксами для определения порядка выполнения
* Роли идемпотентны - могут запускаться несколько раз без побочных эффектов

### Библиотечные функции

* `lib.sh` предоставляет общие функции для логирования, обработки ошибок, управления пакетами и т.д.
* Включает функции для поддержки режима симуляции, проверки системы и верификации безопасности
* Все скрипты и роли используют эти общие функции

### Интеграция с Makefile

* Стандартизированный интерфейс для общих операций (lint, fmt, dry-run, install)
* Поддерживает как разработческие, так и производственные рабочие процессы

## Использование

### Использование нового фреймворка

1. Клонируйте репозиторий:
    ```bash
    git clone https://github.com/asvspb/ubuntuInstaller.git
    ```
2. Настройте файл `config.yaml` под свои нужды:
    ```yaml
    settings:
      non_interactive: true
      log_file: "/var/log/ubuntuInstaller/install.log"
    profile: "auto" # Автоматическое определение профиля (desktop-developer, server, wsl)
    roles_enabled:
      - name: 0-base-system
      - name: 10-dev-tools
        vars:
          install_vscode: true
          install_pycharm: false
      - name: 20-docker
        enabled: true
    ```
3. Запустите симуляцию установки:
    ```bash
    # Используя make (упрощенная симуляция)
    make dry-run
    
    # Используя основной скрипт (полная симуляция с обработкой конфигурации)
    ./install.sh --dry-run
    ```
4. Запустите установку:
    ```bash
    sudo ./install.sh install
    # Или используя make
    sudo make install
    ```
5. Для удаления компонентов:
    ```bash
    sudo ./install.sh uninstall
    # Или используя make
    sudo make uninstall
    ```
6. Для обновления установленных компонентов:
    ```bash
    sudo ./install.sh update
    # Или используя make
    sudo make update
    ```

### Профили

Фреймворк поддерживает различные профили системы:
- `desktop-developer` - Полнофункциональная десктопная система для разработки
- `server` - Серверная система с минимальным набором компонентов
- `wsl` - Система для Windows Subsystem for Linux
- `auto` - Автоматическое определение профиля на основе характеристик системы

Вы можете указать профиль в конфигурационном файле или использовать один из предопределенных профильных конфигурационных файлов в директории `profiles/`:
    ```bash
    sudo ./install.sh -c profiles/desktop-developer.yaml
    sudo ./install.sh -c profiles/server.yaml
    sudo ./install.sh -c profiles/wsl.yaml
    ```

### Интерактивный режим

Фреймворк включает мини-TUI для интерактивного выбора профилей и ролей:
    ```bash
    sudo ./mini-tui.sh
    ```

Учтите, что устаревшая версия этого скрипта находится в директории `scripts/`.
Пожалуйста, используйте версию в корне проекта для получения последних функций и исправлений.

### Цели Makefile

* `make lint` - Проверка синтаксиса всех shell-скриптов с помощью shellcheck
* `make fmt` - Форматирование всех shell-скриптов с помощью shfmt
* `make fmt-check` - Проверка форматирования всех shell-скриптов (не изменяет файлы)
* `make dry-run` - Симуляция установки без внесения изменений (упрощенная)
* `make dry-run-desktop-developer` - Симуляция установки с профилем desktop-developer
* `make dry-run-server` - Симуляция установки с профилем server
* `make dry-run-wsl` - Симуляция установки с профилем wsl
* `make validate-config` - Проверка валидности конфигурационных файлов
* `make install` - Выполнение процесса установки
* `make uninstall` - Удаление установленных компонентов
* `make update` - Обновление установленных компонентов
* `make info` - Отображение информации о фреймворке

### Опции конфигурации

Файл `config.yaml` поддерживает следующие опции:

* `settings.non_interactive` - Запуск без запросов пользователю (по умолчанию: true)
* `settings.log_file` - Путь к файлу журнала (по умолчанию: /var/log/ubuntuInstaller/install-$(date +%Y-%m-%d).log)
* `profile` - Профиль системы (desktop-developer, server, wsl, auto)
* `roles_enabled` - Список ролей для выполнения с опциональными переменными
* `roles_enabled[n].enabled` - Включить или отключить конкретную роль (по умолчанию: true)
* `roles_enabled[n].vars` - Переменные для передачи в роль

### Разработка ролей

Для создания новой роли:

1. Создайте директорию в `roles/` с числовым префиксом (например, `30-new-role/`)
2. Добавьте скрипт `main.sh`, который использует функции из `lib.sh`
3. Опционально добавьте скрипт `uninstall.sh` для удаления роли
4. Добавьте ссылку на роль в `config.yaml`

Роли должны быть идемпотентными и поддерживать режим симуляции через переменную `DRY_RUN`.

### Фаза 4: Откат и управление состоянием

Фреймворк теперь поддерживает расширенные функции отката и управления состоянием:

#### Поддержка удаления

* Каждая роль может иметь скрипт `uninstall.sh` для удаления компонентов
* Используйте `./install.sh uninstall` или `make uninstall` для удаления установленных компонентов
* Роли удаляются в обратном порядке установки

#### Предварительные снимки для критических ролей

* Автоматические снимки создаются перед установкой критических ролей (0-base-system, 20-docker, 30-secure-default)
* Требуется установка Timeshift для функциональности снимков
* Снимки создаются с описательными комментариями для легкой идентификации

#### Механизм обновления

* Используйте `./install.sh update` или `make update` для обновления установленных компонентов
* Роли обновляются или переустанавливаются по мере необходимости
* Отслеживание состояния гарантирует выполнение только необходимых обновлений

#### Отслеживание состояния

* Установленные роли отслеживаются в `/var/lib/ubuntuInstaller.state`
* Предотвращает дублирующиеся установки и обеспечивает правильные операции обновления/удаления
* Файл состояния автоматически управляется фреймворком

### Устаревшие скрипты (Не рекомендуются)

Все скрипты в директории `scripts/` устарели и больше не поддерживаются.
Пожалуйста, используйте основной фреймворк установки с единым entrypoint:

```bash
sudo ./install.sh install
```

Для получения информации о новом фреймворке смотрите разделы выше.

### Настройка разработки

Для обеспечения качества кода и единообразия в проекте рекомендуется настроить pre-commit хуки:

1. Установите pre-commit:
    ```bash
    pip install pre-commit
    # или
    sudo apt install pre-commit
    ```

2. Установите хуки в репозитории:
    ```bash
    pre-commit install
    ```

После этого при каждом коммите будут автоматически выполняться проверки:
- shellcheck для проверки синтаксиса shell-скриптов
- форматирование shell-скриптов с помощью shfmt
- проверка на лишние пробелы и концы файлов
- проверка конфликта слияний
- форматирование shell-скриптов

Также в репозитории настроены правила форматирования в файле `.editorconfig`, которые поддерживаются большинством редакторов кода.

## Решение проблемы с установкой Python-пакетов

В проекте была решена проблема с установкой Python-пакетов, конфликтующих с системными пакетами. При установке пакетов Flask и pandas могла возникать ошибка:

```
error: uninstall-distutils-installed-package
× Cannot uninstall blinker 1.4
```

### Решение

Для решения проблемы был создан специальный скрипт `scripts/python-pip-installer.sh`, который использует несколько стратегий установки Python-пакетов:

1. Использование флага `--break-system-packages`
2. Использование флага `--ignore-installed`
3. Комбинация флагов

Скрипт автоматически выбирает подходящую стратегию установки, чтобы избежать попыток удаления системных пакетов.

### Использование

При установке Python-пакетов в проекте теперь используется скрипт:

```bash
./scripts/python-pip-installer.sh package1 package2 package3
```
    ```

Файл `config.yaml` поддерживает следующие опции:

* `settings.non_interactive` - Запуск без запросов пользователю (по умолчанию: true)
* `settings.log_file` - Путь к файлу журнала (по умолчанию: /var/log/ubuntuInstaller/install-$(date +%Y-%m-%d).log)
* `profile` - Профиль системы (developer, server, wsl)
* `roles_enabled` - Список ролей для выполнения с опциональными переменными
* `roles_enabled[n].enabled` - Включить или отключить конкретную роль (по умолчанию: true)
* `roles_enabled[n].vars` - Переменные для передачи в роль

### Разработка ролей

Для создания новой роли:

1. Создайте директорию в `roles/` с числовым префиксом (например, `30-new-role/`)
2. Добавьте скрипт `main.sh`, который использует функции из `lib.sh`
3. Добавьте ссылку на роль в `config.yaml`

Роли должны быть идемпотентными и поддерживать режим симуляции через переменную `DRY_RUN`.

### Устаревшие скрипты (Не рекомендуются)

1. Перейдите в директорию скриптов:
    ```bash
    cd ubuntuInstaller/scripts
    ```
2. Сделайте нужный скрипт исполняемым:
    ```bash
    chmod +x script_name.sh
    ```
3. Запускайте скрипты по порядку, начиная с `1_ubuntuStart.sh`:
    ```bash
    sudo ./1_ubuntuStart.sh